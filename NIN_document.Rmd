---
title: "Spotify Project Document"
author: "Nissa Ferm"
date: "6/24/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


One of my favorite bands as a teenager was Nine Inch Nails. I remember watching the music video Head Like a Hole and being blown away. Trent Reznor was my new teenage crush. It wasn't until I was in my twenties that I finally got to go see NIN live, with Queens of the Stone Age! I dressed in the black vinly and leather pieces I had in my closet along with my coveted knee high Doc Martins. My inner teenager squeed with delight. I don't listen to NIN as much as I used too, mainly becasue my musical tastes have changed and expanded since I was a teenager. Even though the music of the earlier albums was angst ridden and rough it pumped me up. I would listen to the albums over and over again. I had Pretty Hate Machine on tape and I wore that poor tape out on my yellow Sports Sony walkman with the Super Bass button down. Do we loose that need for super angsty/angry music as we age? Do the albums shift how they make me feel over time? 

This led me to ask two questions about the NIN. 
  
  *Hypothiesis One: As Trent Reznor and NIN aged; the musical positivity, measured as valence, increased over time.*

The other question has to do with Head Like a Hole in particular, as that was my gateway into NIN. There have been plenty of covers of this song since it came out, cough cough in 1989. According to Second Hand Songs[https://secondhandsongs.com/performance/1086/versions#nav-entity] there are 20 cover versions of Head Like a Hole. 

  *Hypothesis Two: Do the cover versions maintain the same musical positivity, measured as valence, as the original?*
  
In order to test these two hypothesis we will use the R package SpotifyR[https://github.com/charlie86/spotifyr]. 

```{r warning=FALSE, include=FALSE}
#remotes::install_github('charlie86/spotifyr')
#remotes::install_github("coolbutuseless/ggecho")
library(spotifyr)
library(tidyverse)
library(ggthemes)
library(ggecho)
library(extrafont)
library(lubridate)
library(zoo)
```

Access tokens
```{r eval=FALSE, include=FALSE}
Sys.setenv(SPOTIFY_CLIENT_ID = '6d375c1d8d904765852f8a7e07f8758f')
Sys.setenv(SPOTIFY_CLIENT_SECRET = 'e54289a3745943388ef262e60cd801b6')

access_token <- get_spotify_access_token()
```

Get data for Nine Inch Nails

```{r eval=FALSE, message=FALSE, warning=FALSE}
nin_data <- get_artist_audio_features(artist = "nine inch nails",
                                      return_closest_artist = TRUE,
                                      authorization = access_token)

# Select colommns and don't select list objects from retrieved data.
nin_tibble <- nin_data %>% 
  select(artist_name, album_name,track_name,track_number, album_release_date,
         danceability:tempo, duration_ms, key_name:key_mode) %>%
  as_tibble()

#Write to file so I don't need to use API again. 
write_csv(nin_tibble, "nin_audio_features_data.csv")
```

```{r}
# Read in the data from file
nin_data <- read_csv("nin_audio_features_data.csv")
```

```{r}
# studio album names
studio_albums <- c("Pretty Hate Machine","Broken","The Downward Spiral", "The Fragile",
                   "With Teeth", "Year Zero", "Ghosts I-IV", 
                   "The Slip", "Hesitation Marks" ,"Bad Witch") 
```
  Limit the analysis to the nine standard studio albums and Broken. The nine studio albums are `r studio_albums` according to wikipedia[https://en.wikipedia.org/wiki/Nine_Inch_Nails_discography#Studio_albums]. It does not include bonus tracks.  There are some duplications in the dataset, which look like they stem from significant digit differences. We need to remove the duplicates. The duplicates are removed by using album_name and track_name. Don't use track number this would filter out multiple disks from a single album. Also convert the album_release_date which is a character into a Date format using lubridate. Also let's add Trent Reznors age.  
  First a little bit about what valence means as a positivity measure for a song. From my background valence is a term I remember from chemistry and physics. But in the Spotify world it has nothing to do with orbitals and electrons. This is how Spotify defines valence, 
    "A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry)." The definition can be found in the API documentation[https://developer.spotify.com/documentation/web-api/reference/tracks/get-several-audio-features/]. So, valence is how the music makes me feel, not necessarily how the artist feels while they are making the music. Or is it? 


```{r}
nin_select_albums <-  nin_data %>%
  filter(album_name %in% studio_albums) %>%
  mutate(album_release_date = lubridate::ymd(album_release_date))%>%
  distinct(album_name, track_name, .keep_all = TRUE) %>%
  mutate(Trent_Reznor_age = 
           #We are going to ignore leap years
          as.integer((album_release_date - lubridate::ymd("1965-05-17"))/365)) %>%
  # match the happiness study bins, with an estimate of subrtract two for age of working
  # on album.
  mutate(four_year_bins = cut(Trent_Reznor_age - 2, 
                              breaks = seq(from = 18, to = 86, by = 4),
                              labels = c("18-21", "22-25", "26-29", "30-33", "34-37",
                                         "38-41", "42-45", "46-49", "50-53", "54-57",
                                         "58-61", "62-65", "66-69", "70-73", "74-77",
                                         "78-81", "82-85")))
```

plot valence data
```{r}
ggplot(data = nin_select_albums)+
  geom_jitter(aes(x = lubridate::year(album_release_date), y = valence,
                   color = album_name))+
  geom_smooth(aes(x = lubridate::year(album_release_date), y = valence),
              smooth = "loess")+
  geom_boxplot(aes(x = lubridate::year(album_release_date), y = valence,
                   color = album_name), alpha = 0.3, outlier.colour = "red")

```
It might be a stretch but this plot reminds me of the happiness/ well being by age studies with the plataue and U bend in self reported happiness. Read up on the happiness study here [https://www.pnas.org/content/107/22/9985].  Since I don't have access to the original data I can use the WebPlotDigitizer[https://automeris.io/WebPlotDigitizer/] on the jpeg from the research paper, then download the .csv file and then read it into R. 
```{r}
happiness_data <- read_delim("happiness_data.csv", ";", escape_double = FALSE, 
                             trim_ws = TRUE) %>% select(Level, four_year_bins, WB_Ladder)
```


```{r}
trent_happy_plot <- nin_select_albums %>%
  group_by(four_year_bins)%>%
  mutate(mean_valence = mean(valence, na.rm = TRUE))%>%
  distinct(four_year_bins, .keep_all = TRUE)%>%
  select(Trent_Reznor_age, four_year_bins, mean_valence)%>%
  full_join(happiness_data, by = "four_year_bins")%>%
  #this is so I can use facet when I plot.
  gather(`mean_valence`, `WB_Ladder`, key = "Study", value = "value")
```

There are two NA's in the mean valence time series for Trent. I will use na.approx from the zoo package to estimate the values so there isn't a break in the graph. 

```{r}
trent_zoo <- trent_happy_plot %>%
  filter(Study == "mean_valence" & Level < 9)

missing_val <- na.approx(trent_zoo$value ,trent_zoo$Level)

trent_happy_plot[8, "value"] <- missing_val[8]
trent_happy_plot[9, "value"] <- missing_val[9]  

```


I picked the color pallete by using the Pretty Hate Machine cover art [https://www.nin.wiki/images/4/40/PHMvinyl.jpg]and extracting the major hex colors using color explorer[http://www.colorexplorer.com/imageimport.aspx] 
Nine in Nail fonts can be found here[https://www.nindestruct.com/fonts.html]. The extrafont package can only handle true type fonts .ttf so pick wisley. 

```{r}
phm_colors <- c("#050718","#2a6e97", "#935498", "#2b8eba", "#cb0066")
```

```{r}
ggplot()+
  geom_line(aes(Level, value), na.rm = FALSE, color = phm_colors[4],
            stat = 'echo', size = 0.4,
            data = trent_happy_plot)+
  geom_point(aes(Level, value), fill = phm_colors[3], color = phm_colors[5],
             shape = 21, stat = 'echo', size = 3,
             #remove the points for replace.na, since they are not real observations.
             data = trent_happy_plot[-8:-9,])+
  theme_clean()+
  theme(axis.text.x = element_text(color= phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 10),
        axis.title.x = element_text(color = phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 10),
        axis.text.y = element_text(color= phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 10),
        strip.text = element_text(color= phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 9),
        panel.border = element_rect(color = phm_colors[4], fill = NA),
        panel.background = element_rect(fill = phm_colors[1]))+
  ylab(label = NULL)+
  scale_x_continuous(name = "Age", breaks = 0:16,
                     labels = c("18\n-\n21", "22\n-\n25", "26\n-\n29", 
                                "30\n-\n33", "34\n-\n37", "38\n-\n41",
                                "42\n-\n45", "46\n-\n49", "50\n-\n53", 
                                "54\n-\n57", "58\n-\n61", "62\n-\n65",
                                "66\n-\n69", "70\n-\n73", "74\n-\n77",
                                "78\n-\n81", "82\n-\n85"))+
  facet_wrap(~ Study, nrow = 2, scales = "free_y",
             strip.position = "right", 
             labeller = as_labeller(c('mean_valence' = "nin mean valence",
                                      'WB_Ladder' = "mean happiness")))
```

Will NIN albums make us feel happier in the future? 

```{r}

trent_glm <- glm(Trent_Reznor_age ~ valence + danceability + energy + tempo, 
                 data = nin_select_albums)
plot(trent_glm)
```

```{r}
library(gam)
```

```{r}
trent_gam <- gam(Trent_Reznor_age ~ valence , 
                 data = nin_select_albums)

```

```{r}
plot(trent_gam, se = TRUE)
```
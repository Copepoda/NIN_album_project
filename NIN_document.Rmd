---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<font style="font-family: TheFragileBoldCaps; font-size:18pt; font-style:bold">
  
Downward into Happiness  
  
</font>
```{r echo=FALSE, out.width = "20%",out.extra='style="float:left; padding:10px"'}
knitr::include_graphics("https://www.nin.wiki/images/4/40/PHMvinyl.jpg")
```
<font style="font-family: helvetica; font-size:12pt">
remember watching the music video *Head Like a Hole* and being blown away. Nine Inch Nails was instantly my new favorite band and Trent Reznor become my new teenage crush `r emo::ji("heart_eyes")`. It wasn't until I was in my twenties that I finally got to go see NIN live, with Queens of the Stone Age! I dressed in the black vinly and leather pieces I had in my closet along with my coveted knee high Doc Martins. My inner teenager squeed with delight. I don't listen to NIN as much as I used too, mainly becasue my musical tastes have changed and expanded since I was a teenager. I had Pretty Hate Machine on tape and I wore that poor tape out on my yellow Sony Sports Walkman with the Super Bass button down. The album is so seared in my mind that if one of the songs from Pretty Hate Machine comes up in a play list my mind is waiting for the next song on the album to play. And when it doesn't, I'm a little dissapointed. Pretty Hate Machine was my jam and made me feel pumped. Music has a way of giving voice to our feelings and have influence on them. There is a music metric which is reflective of how a song makes us feel called valence.   
    From my science background valence is a term I remember from chemistry and physics. But in the Spotify world it has nothing to do with orbitals and electrons. This is how Spotify defines valence,  
    
  *"A measure from 0.0 to 1.0 describing the musical positiveness conveyed by a track. Tracks with high valence sound more positive (e.g. happy, cheerful, euphoric), while tracks with low valence sound more negative (e.g. sad, depressed, angry)."*   
  
  The definition and some explination into its creation can be found in the [Spotify documentation](https://developer.spotify.com/documentation/web-api/reference/tracks/get-several-audio-features/). Considering how pumped that album made me feel and the shifts in the subsiquent albums, did the valence of Nine Inch Nails albums change over time?   
</font>
```{r echo=FALSE, message=FALSE, warning=FALSE}
##
#remotes::install_github('charlie86/spotifyr')
#remotes::install_github("coolbutuseless/ggecho")
library(spotifyr)
library(tidyverse)
library(ggthemes)
library(ggecho)
library(extrafont)
library(lubridate)
library(zoo)
```
<font style="font-family: TheFragileBoldCaps; font-size:14pt; font-style:bold">
  
... how this got started 
  
</font>
```{r echo=FALSE, message=FALSE, warning=FALSE}
source("access_token.R")
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
nin_data <- spotifyr::get_artist_audio_features(artist = "nine inch nails",
                                      return_closest_artist = TRUE,
                                      authorization = access_token)

# Select colommns and don't select list objects from retrieved data.
nin_tibble <- nin_data %>% 
  dplyr::select(artist_name, album_name,track_name,track_number, album_release_date,
         danceability:tempo, duration_ms, key_name:key_mode) %>%
  dplyr::as_tibble()

#Write to file so I don't need to use API again. 
readr::write_csv(nin_tibble, "nin_audio_features_data.csv")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Read in the data from file
nin_data <- readr::read_csv("nin_audio_features_data.csv")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# studio album names
studio_albums <- c("Pretty Hate Machine","Broken","The Downward Spiral", "The Fragile",
                   "With Teeth", "Year Zero", "Ghosts I-IV", 
                   "The Slip", "Hesitation Marks" ,"Bad Witch") 
```
<font style="font-family: helvetica; font-size:12pt"> 
    In order to answer my question I used the R package [spotifyr](https://github.com/charlie86/spotifyr), to retrieve the data from Spotify. Check the link if you want to know more about the spotifyr package and how set up your dev acount with Spotify. Also if you want to see all the [tidyverse](https://www.tidyverse.org/) code for this document visit my [Github repo](). I limited the analysis to the nine standard studio albums and Broken. The [ten albums](https://en.wikipedia.org/wiki/Nine_Inch_Nails_discography#Studio_albums) are `r studio_albums[1:9]`, and `r studio_albums[10]`. There were some duplications in the dataset, which look like they stemmed from significant digit differences. The duplicates were removed by using album_name and track_name. Don't use track number this would filter out multiple disks from a single album. For plotting the albums and valence I used the color pallete from the Pretty Hate Machine [cover art](https://www.nin.wiki/images/4/40/PHMvinyl.jpg) and extracted the major hex colors using [color explorer](http://www.colorexplorer.com/imageimport.aspx). In keeping with the theme I made sure to have NIN fonts as well, 
some fonts can be found [here](https://www.nindestruct.com/fonts.html). In order to install the fonts I used the [extrafont package](https://cran.r-project.org/web/packages/extrafont/README.html). For this type of data a box plot is the most appropriate so you can visualize the realtive difference between the  albums. The bar in the middle of the box represents the median valence of the album, while the upper and lower bounds of the box correspond to the 25th and 75th percentiles. Meaning that 50% of the data fall within the box and data that are beyond the whiskers are outliers. There do appear to be differences in valence between albums. Most notably the first two Pretty Hate Machine and Broken. 
</font>
```{r echo=FALSE, message=FALSE, warning=FALSE}
nin_select_albums <-  nin_data %>%
  dplyr::filter(album_name %in% studio_albums) %>%
  dplyr::mutate(album_release_date = lubridate::ymd(album_release_date))%>%
  distinct(album_name, track_name, .keep_all = TRUE) 
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
phm_colors <- c("#050718","#2a6e97", "#935498", "#2b8eba", "#cb0066")
phm_ramp <- grDevices::colorRampPalette(c(phm_colors[3], phm_colors[4]))(10)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
nin_box_albums <- ggplot2::ggplot(data = nin_select_albums)+
  ggplot2::geom_point(aes(x = lubridate::year(album_release_date), y = valence,
                   color = album_name), 
              fill = phm_colors[3],
              color = phm_colors[5],
              shape = 21, stat = 'echo', size = 1)+
  ggplot2::geom_boxplot(aes(x = lubridate::year(album_release_date), y = valence,
                   color = album_name),
               alpha = 0.05 , 
               outlier.color = "white",
               outlier.alpha = 0.2,
               outlier.size = 5)+
  ggplot2::scale_color_manual(values = phm_ramp)+
  ggplot2::scale_fill_manual(values = phm_ramp)+
  ggplot2::xlab(label = "Year")+
  ggplot2::ggtitle(label = "NIN Albums")+
  ggthemes::theme_clean()+
  ggplot2::theme(
    title = ggplot2::element_text(color= phm_colors[2],
                                      family = "TheFragileBoldCaps",
                                      size = 12),
    axis.text = ggplot2::element_text(color= phm_colors[2],
                                      family = "TheFragileBoldCaps",
                                      size = 10),
    axis.title = ggplot2::element_text(color = phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 10),
    legend.position = "none",
    panel.border = ggplot2::element_rect(color = phm_colors[4], fill = NA),
    panel.background = ggplot2::element_rect(fill = phm_colors[1]),
    plot.background = ggplot2::element_blank())

print(nin_box_albums)


```
<font style="font-family: TheFragileBoldCaps; font-size:14pt; font-style:bold">
  
... down in it 
  
</font>
```{r echo=FALSE, message=FALSE, warning=FALSE}
nin_select_albums %>%
  split(.$album_name) %>%
  purrr::map(~ shapiro.test(.$valence)) %>%
  purrr::map_dfr(~ broom::tidy(.), .id = 'Album') %>%
  dplyr::mutate(p.value = round(p.value, 3),
                statistic = round(statistic, 3)) %>%
  dplyr::mutate(p.value = kableExtra::cell_spec(p.value, "html",
                                               color = ifelse(p.value < 0.05,
                                                              "red", "black"))) %>%
  dplyr::select(-method) %>%
  kableExtra::kable(format = "html", escape = F) %>%
  kableExtra::kable_styling(full_width = F, position = "float_right") %>%
  kableExtra::add_header_above(c(" ", "Shapiro-Wilk Normality Test" = 2), align = "left") %>%
  kableExtra::add_header_above(c("Step One:" = 3), align = "left")
```

<font style="font-family: helvetica; font-size:12pt">
In order to test if the valence is different between the ablums we first need to run a few tests. First we test for normality, we can do this using the Shapiro-Wilk Normailty test. From the output, if a p-value > 0.05 it implies that the distribution of the data are not significantly different from normal distribution. In other words, we can assume the normality. Looking at the table we can see that a few of the albums have a non-normal distribution. 
Next is to test for homogeneity of the variances, since the data already broke the normality assumption we should use the Levene test and not the Bartlett's. The variances are not different according to the Levene test. 
</font>
<font style="font-family: TheFragileBoldCaps; font-size:14pt; font-style:bold">
  
... maybe I want to
  
</font>

<font style="font-family: helvetica; font-size:12pt">
I want to see if the valence of the albums are actually different from each other, but I'll go with a non-parametric test since we broke one of our assumptions in step one. To do this we can use the Kruskal-Wallis test, which tests if the medians of the valence among the albums are equal. The p-value from the Kruskal-Wallis test indicates that we should have a further look, that the valence of some of the albums might be different from each other. If we look back at the boxplot there are a couple of albums which stand out as being different from each other. Pretty Hate Machine, Broken, Hesitation Marks, and Bad Witch are the most interesting. These all have normal distibutions so we can go ahead and use the simple t.test, since the Wilcox test would be overkill.
</font>
```{r echo=FALSE, message=FALSE, warning=FALSE}
car::leveneTest(valence ~ as.factor(album_name), data = nin_select_albums) %>%
  broom::tidy(.) %>%
  dplyr::mutate(p.value = round(p.value, 3), 
                statistic = round(statistic, 3)) %>%
  dplyr::select(-term) %>%
  dplyr::slice(1) %>%
  kableExtra::kable(format = "html", escape = F) %>%
  kableExtra::kable_styling(full_width = F, position = "float_left") %>%
  kableExtra::add_header_above(c("Levene's Test for Homogeneity of Variance " = 3),
                               align = "left") %>%
  kableExtra::add_header_above(c("Step Two:" = 3), align = "left")
  
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
stats::kruskal.test(valence ~ album_name, data = nin_select_albums) %>%
  broom::tidy(.) %>%
  dplyr::select(parameter, statistic, p.value) %>%
  dplyr::mutate(p.value = round(p.value, 3),
               statistic = round(statistic, 3),
               p.value = kableExtra::cell_spec(p.value, "html",
                                               color = ifelse(p.value < 0.05,
                                                              "red", "black"))) %>%
  kableExtra::kable(format = "html", escape = F) %>%
  kableExtra::kable_styling(full_width = F, position = "float_right") %>%
  kableExtra::add_header_above(c("Kruskal-Wallis rank sum test" = 3), align = "left") %>%
  kableExtra::add_header_above(c("Step Three:" = 3), align = "left")
```

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
box_plot_labels <- nin_select_albums %>%
  dplyr::select(album_name, album_release_date, valence) %>%
  dplyr::group_by(album_name, album_release_date) %>%
  dplyr::summarise(valence = quantile(valence,.75)) %>%
  dplyr::filter(album_name %in% c("Pretty Hate Machine", "Broken",
                                  "Hesitation Marks","Bad Witch"))

nin_box_albums +
  ggrepel::geom_text_repel(aes(x = lubridate::year(album_release_date), y = valence),
            label = box_plot_labels$album_name, data = box_plot_labels, 
            family = "TheFragileBoldCaps", color = phm_colors[4],
            arrow = arrow(length = unit(0.03, "npc"), type = "closed", ends = "last"),
            nudge_y = 0.27,
            nudge_x = 2,
            segment.color = phm_colors[4])
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
phm <- nin_select_albums %>%
  filter(album_name == "Pretty Hate Machine") %>%
  select(valence) %>% pull()
  
broken <- nin_select_albums %>%
  filter(album_name == "Broken") %>%
  select(valence) %>% pull()

bad_witch <- nin_select_albums %>%
  filter(album_name == "Bad Witch") %>%
  select(valence) %>% pull()

hesitation <- nin_select_albums %>%
  filter(album_name == "Hesitation Marks") %>%
  select(valence) %>% pull()
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
phm_broken <- t.test(phm, broken) %>% broom::tidy(.) %>%
  mutate(Albums = "Pretty Hate Machine / Broken")
phm_bad <- t.test(phm, bad_witch) %>% broom::tidy(.) %>%
  mutate(Albums = "Pretty Hate Machine / Bad Witch")
phm_hes <- t.test(phm, hesitation) %>% broom::tidy(.) %>%
  mutate(Albums = "Pretty Hate Machine / Hesitation Marks")
broken_hes <- t.test(broken, hesitation) %>% broom::tidy(.) %>%
  mutate(Albums = "Broken / Hesitation Marks")
broken_bad <- t.test(broken, bad_witch) %>% broom::tidy(.) %>%
  mutate(Albums = "Broken / Bad Witch")
hes_bad <- t.test(hesitation, bad_witch) %>% broom::tidy(.) %>%
  mutate(Albums = "Hesitation Marks / Bad Witch")

phm_broken %>% 
  dplyr::bind_rows(phm_bad, broken_hes,phm_hes, broken_bad, hes_bad ) %>%
  dplyr::select(Albums, statistic, estimate1, estimate2, p.value, method) %>%
  dplyr::arrange(p.value) %>%
  dplyr::mutate(p.value = round(p.value, 3),
                statistic = round(statistic, 3),
                estimate1 = round(estimate1, 2),
                estimate2 = round(estimate2, 2),
                p.value = kableExtra::cell_spec(p.value, "html",
                                               color = ifelse(p.value < 0.05,
                                                              "red", "black"))) %>%
  dplyr::select(Albums, estimate1, estimate2, statistic, p.value) %>%
  dplyr::rename(`Mean album 1` = estimate1,
                `Mean album 2` = estimate2) %>%
  kableExtra::kable(format = "html", escape = F) %>%
  kableExtra::kable_styling() %>%
  kableExtra::add_header_above(c("", "Welch Two Sample t-test" = 4), align = "left")
```

Let's look at the plot again. It might be a stretch but this plot reminds me of the happiness/ well being by age studies with the plataue and U bend in self reported happiness. Read up on the [happiness study](https://www.pnas.org/content/107/22/9985).  Since I don't have access to the original data I can use the [WebPlotDigitizer](https://automeris.io/WebPlotDigitizer/) on the jpeg from the research paper, then download the .csv file and then read it into R. 
```{r echo=FALSE, message=FALSE, warning=FALSE, out.width = "40%",out.extra='style="float:right; padding:10px"'}


nin_box_albums +
  geom_line(aes(x = lubridate::year(album_release_date), y = valence),
            color = phm_colors[2],
            size = 2, alpha = 0.6,
            data = nin_select_albums %>% 
              group_by(album_release_date) %>%
              summarise(valence = stats::median(valence, na.rm = TRUE)))
```



add age

```{r echo=FALSE, message=FALSE, warning=FALSE}
nin_select_albums <-  nin_select_albums %>%
  dplyr::mutate(Trent_Reznor_age = 
           #We are going to ignore leap years
          as.integer((album_release_date - lubridate::ymd("1965-05-17"))/365)) %>%
  # match the happiness study bins, with an estimate of subrtract two for age of working
  # on album.
  dplyr::mutate(four_year_bins = cut(Trent_Reznor_age - 2, 
                              breaks = seq(from = 18, to = 86, by = 4),
                              labels = c("18-21", "22-25", "26-29", "30-33", "34-37",
                                         "38-41", "42-45", "46-49", "50-53", "54-57",
                                         "58-61", "62-65", "66-69", "70-73", "74-77",
                                         "78-81", "82-85")))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
happiness_data <- read_delim("happiness_data.csv", ";", escape_double = FALSE, 
                             trim_ws = TRUE) %>% select(Level, four_year_bins, WB_Ladder)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
trent_happy_plot <- nin_select_albums %>%
  group_by(four_year_bins)%>%
  mutate(mean_valence = mean(valence, na.rm = TRUE))%>%
  distinct(four_year_bins, .keep_all = TRUE)%>%
  select(Trent_Reznor_age, four_year_bins, mean_valence)%>%
  full_join(happiness_data, by = "four_year_bins")%>%
  #this is so I can use facet when I plot.
  gather(`mean_valence`, `WB_Ladder`, key = "Study", value = "value")
```

There are two NA's in the mean valence time series for Trent. I will use na.approx from the zoo package to estimate the values so there isn't a break in the graph. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
trent_zoo <- trent_happy_plot %>%
  filter(Study == "mean_valence" & Level < 9)

missing_val <- na.approx(trent_zoo$value ,trent_zoo$Level)

trent_happy_plot[8, "value"] <- missing_val[8]
trent_happy_plot[9, "value"] <- missing_val[9]  

```



```{r echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
ggplot()+
  geom_line(aes(Level, value), na.rm = FALSE, color = phm_colors[4],
            stat = 'echo', size = 0.4,
            data = trent_happy_plot)+
  geom_point(aes(Level, value), fill = phm_colors[3], color = phm_colors[5],
             shape = 21, stat = 'echo', size = 3,
             #remove the points for replace.na, since they are not real observations.
             data = trent_happy_plot[-8:-9,])+
  theme_clean()+
  theme(axis.text.x = element_text(color= phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 10),
        axis.title.x = element_text(color = phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 10),
        axis.text.y = element_text(color= phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 10),
        strip.text = element_text(color= phm_colors[2], 
                                   family = "TheFragileBoldCaps",
                                   size = 9),
        panel.border = element_rect(color = phm_colors[4], fill = NA),
        panel.background = element_rect(fill = phm_colors[1]))+
  ylab(label = NULL)+
  scale_x_continuous(name = "Age", breaks = 0:16,
                     labels = c("18\n-\n21", "22\n-\n25", "26\n-\n29", 
                                "30\n-\n33", "34\n-\n37", "38\n-\n41",
                                "42\n-\n45", "46\n-\n49", "50\n-\n53", 
                                "54\n-\n57", "58\n-\n61", "62\n-\n65",
                                "66\n-\n69", "70\n-\n73", "74\n-\n77",
                                "78\n-\n81", "82\n-\n85"))+
  facet_wrap(~ Study, nrow = 2, scales = "free_y",
             strip.position = "right", 
             labeller = as_labeller(c('mean_valence' = "nin mean valence",
                                      'WB_Ladder' = "mean happiness")))
```

Will NIN albums make us feel happier in the future? 

